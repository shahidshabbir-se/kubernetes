name: CI/CD Pipeline

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GHCR
      run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build and Push Docker image
      run: |
        docker build -t ghcr.io/shahidshabbir-se/kubernetes:latest .
        docker push ghcr.io/shahidshabbir-se/kubernetes:latest

    - name: Prepare SSH key
      run: |
        echo "${{ secrets.VPS_SSH_KEY }}" | base64 --decode > ~/.ssh/vps_key
        chmod 600 ~/.ssh/vps_key

    - name: Deploy to VPS via SSH
      run: |
        ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} << 'EOF'
          cd ~/k8s-node-app
          git pull origin main

          # Optional: Login to GHCR on VPS
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Apply manifests
          kubectl apply -f k8s/postgres/
          kubectl create configmap caddy-config --from-file=k8s/caddy/config/Caddyfile --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/caddy/
          kubectl apply -f k8s/app/
        EOF
