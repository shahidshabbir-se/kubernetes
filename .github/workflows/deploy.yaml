name: CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build and Deploy to Kubernetes via Tailscale
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry (GHCR)
      run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build and Push Docker image to GHCR
      run: |
        docker build -t ghcr.io/shahidshabbir-se/kubernetes:latest .
        docker push ghcr.io/shahidshabbir-se/kubernetes:latest

    - name: Prepare SSH key for Tailscale access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
        chmod 600 ~/.ssh/vps_key

    - name: SSH into VPS and deploy with kubectl
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/vps_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} << 'EOF'
          set -e

          echo "[+] Pulling latest code..."
          cd ~/k8s-node-app
          git pull origin main

          echo "[+] Re-authenticating GHCR (if needed)..."
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "[+] Applying PostgreSQL manifests..."
          kubectl apply -f k8s/postgres/

          echo "[+] Creating/updating Caddy configmap..."
          kubectl create configmap caddy-config --from-file=k8s/caddy/config/Caddyfile --dry-run=client -o yaml | kubectl apply -f -

          echo "[+] Deploying Caddy reverse proxy..."
          kubectl apply -f k8s/caddy/

          echo "[+] Deploying application..."
          kubectl apply -f k8s/app/

          echo "[âœ”] Deployment complete."
        EOF
